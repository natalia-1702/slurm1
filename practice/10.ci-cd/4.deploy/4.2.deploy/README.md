## Deploy

В этой части добавляем последний шаг, деплой приложение в кластер k8s. Деплой производится с использованием утитилы helm3. 

**1. Подготавливаем ci/cd**

Для этого скопируем `.gitlab-ci.yml` в проект `xpaste` выполнив команду:

```bash
$ cp ~/slurm//practice/10.ci-cd/4.deploy/4.2.deploy.gitlab-ci.yml ~/xpaste/
```

**2. Задаем IP kubeapi**

В файл `.gitlab-ci.yml` необходимо прописать IP адрес своего kubeapi. Для того, что бы его получить выполните команду:

```bash
$ kubectl cluster-info
```
Результат должен быть примерно следующим:
```bash
Kubernetes master is running at https://172.18.159.2:6443
KubeDNS is running at https://172.18.159.2:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
```
Теперь значение `Kubernetes master is running at` надо добавить в `.gitlab-ci.yml` для этого откроем его на редактирование:

```bash
$ vi ~/xpaste/.gitlab-ci.yml
```

И заменим строки:
```diff
variables:
-  K8S_API_URL: https://172.<xx>.<yyy>.2:6443
+  K8S_API_URL: https://172.18.159.2:6443
```

``Заменить надо на IP из предидущей команды, а не на тот котрый указан в README.md``

**3. Настройка ingress**

Доступ к приложению будет осушствляться через ingress. Ingress устанавливается вместе с приложением, но для его корректной работы необходимо прописать ему адрес. 
Для этого откроем values.yaml:
```bash
vi ~/xpaste/.helm/values.yaml
```

В конеце файла необходимо заменить строку, `<номер своего логина> меняем на свой номер студента!!`:
```diff
- host: xpaste.s<номер своего логина>.edu.slurm.io
+ host: xpaste.s000001.edu.slurm.io
```

Сохраняем все изменения и пушим их в gitlab для этого необходимо выполнить команды:
```bash
$ cd ~/xpaste
$ git add .
$ git commit -am "Add deploy stage."
$ git push
```

**4. Проеврка результата**

Для проверки результата необходимо перейти в gitlab в раздел `ci/cd -> piplines` форка проекта xpaste. 
Можно воспользоваться прямой ссылкой: `https://gitlab.slurm.io/sXXXXXX/xpaste/pipelines`. `sXXXXXX` необходимо заменить на номер своего студента.

В результате все job должны закончиться без ошибок.

**5.Открываем приложение в бразере**

В браузере открываем url: xpaste.s<номер своего логина>.edu.slurm.io. `<номер своего логина>` необходимо заменить на номер своего студента. Открывать нужно в режиме `инкогнито`.

Если вы увидели `502` ошибку, значит практику выполнили верно.

**6. Самостоятельная работа**

Самостоятельная работа продолжительностью 5 минту. Во время самостоятельной работы надо попробовать ответить на  вопрос:
  * Почему деплой закончился успешно, а приложение недоступно.

Ошибку, пока, испрвлять не надо.

**7. Доработка ci/cd**

  * Для изменения поведения ci/cd в шаге 5 необходимо внести изменения в ci/cd описанные в [snippent](https://gitlab.slurm.io/snippets/60)
  * Для исправления ошибки в работе приложения необходимо внести изменения в chart описанные в [snippet](https://gitlab.slurm.io/snippets/61)

Для проверки открываем в браузере url: `xpaste.s<номер своего логина>.edu.slurm.io`. `<номер своего логина>` необходимо заменить на номер своего студента. Открывать нужно в режиме `инкогнито`. Тепреь приложение должно быть доступно.
